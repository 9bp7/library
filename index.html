<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="styles.css">
        <title>Your Library</title>
    </head>
    <body>
      <header>
        <h1>Your Library</h1>
        <p>Hover over books to edit or remove from library</p>
      </header>

      <main>
        <ul class="bookshelf">
          <!--<li class="book new-book">
            <h3>Add new book</h3>
            <form id="new-book-form">
                <label for="title">Book Title: </label>
                <input type="text" id="title">
                <label for="author">Author: </label>
                <input type="text" id="author">
                <label for="pages">Pages: </label>
                <input type="text" id="pages">
                <label for="readornot">Read yet? </label>
                <input type="checkbox" id="readornot">
                <button type="submit">Add Book</button>
            </form>
          </li>-->
        </ul>
        
        <div class="add-book">
          <button id="btn-addBook">Add Book</button>
        </div>
        
      </main>
     
    </body>

    <script>
      let myLibrary = [];

      function Book(title, author, pages, read) {
        this.title = title;
        this.author = author;
        this.pages = pages;
        this.read = read;
        this.editing = false;
        this.hovering = false;
      }

      function addBookToLibrary(book) {
        myLibrary.push(book);
      }

      function removeBookFromLibrary(index) {
        myLibrary.splice(index, 1);
      }



      function App() {
        bookShelf = null;
        newBookBtn = null;
        addingNewBook = false;
      }

      App.prototype.init = function() {
          this.bookShelf = document.querySelector('.bookshelf');
          this.newBookBtn = document.querySelector('#btn-addBook');
      }

      App.prototype.clearBookshelf = function() {
        _this = this;
        let booksExclNewBookCard = this.bookShelf.querySelectorAll(".book");
        booksExclNewBookCard.forEach(book => {
          if(!book.classList.contains("new-book") || (book.classList.contains("new-book") && !_this.addingNewBook)) {
            _this.bookShelf.removeChild(book);
          }
        });
      }

      App.prototype.render = function() {
        this.clearBookshelf();

        for(let i = myLibrary.length - 1; i >= 0; i--) {
          let book = document.createElement('li');
          book.setAttribute('data-id', i);
          book.classList.add('book');
          if(!myLibrary[i].editing) {
            book.innerHTML = 
                `<p class="book-remove ${myLibrary[i].hovering ? "" : "no-show"}">Remove</p>
                <h3>${myLibrary[i].title}</h3>
                <p>by <i>${myLibrary[i].author}</i></p>
                <p>${myLibrary[i].pages} pages</p>`
            if(myLibrary[i].read) {
                book.innerHTML += `<p>Finished</p>`;
            } else {
                book.innerHTML += `<p>Not read yet</p>`;
            }
            book.innerHTML += `<button class="book-edit no-show">Edit</button>`;
          } else {
            book.innerHTML = 
            `<h3>Edit book</h3>
             <form id="new-book-form">
               <label for="title">Book Title: </label>
               <input type="text" id="edit-title" value="${myLibrary[i].title}">
               <label for="author">Author: </label>
               <input type="text" id="edit-author" value="${myLibrary[i].author}">
               <label for="pages">Pages: </label>
               <input type="text" id="edit-pages" value="${myLibrary[i].pages}">
               <label for="readornot">Read yet? </label>
               <input type="checkbox" id="edit-readornot" ${myLibrary[i].read ? "checked" : ""}>
               <div class="form-buttons">
                 <button type="submit" id="btn-editBook-save">Save Changes</button>
                 <button type="submit" id="btn-editBook-cancel">Cancel</button>
               </div>
             </form>`;
          }
          
          this.bookShelf.prepend(book);
        }

        this.editButtonEvent();
        this.removeBookButtonEvent();
      }

      App.prototype.handleNewBookCardButtons = function(_this) {
        // Handle confirm button
        let confirmNewBookBtn = document.querySelector('#btn-newBook');
        confirmNewBookBtn.addEventListener('click', function(e) {
          e.preventDefault();
          let newBook = new Book(document.querySelector("#title").value,
                                 document.querySelector("#author").value,
                                 document.querySelector("#pages").value,
                                 document.querySelector("#readornot").checked);
          addBookToLibrary(newBook);
          _this.addingNewBook = false;
          _this.render();         
          _this.newBookBtn.classList.remove('no-show');  
        });
        
        // Handle cancel button
        let cancelNewBookBtn = document.querySelector('#btn-cancel');
        cancelNewBookBtn.addEventListener('click', () => _this.toggleNewBookCard(_this)); 
      }

      App.prototype.showNewBookCard = function(_this) {
        let newBookCard = document.createElement('li');
        newBookCard.classList.add('book');
        newBookCard.classList.add('new-book');
        newBookCard.innerHTML = 
            `<h3>Add new book</h3>
             <form id="new-book-form">
               <label for="title">Book Title: </label>
               <input type="text" id="title">
               <label for="author">Author: </label>
               <input type="text" id="author">
               <label for="pages">Pages: </label>
               <input type="text" id="pages">
               <label for="readornot">Read yet? </label>
               <input type="checkbox" id="readornot">
               <div class="form-buttons">
                 <button type="submit" id="btn-newBook">Add Book</button>
                 <button type="submit" id="btn-cancel">Cancel</button>
               </div>
             </form>`;
        _this.bookShelf.appendChild(newBookCard);
        _this.newBookBtn.classList.add('no-show');
        _this.addingNewBook = true;
        _this.handleNewBookCardButtons(_this);
      }

      App.prototype.hideNewBookCard = function(_this) {
        let newBookCard = _this.bookShelf.querySelector('.new-book');
        _this.bookShelf.removeChild(newBookCard);
        _this.newBookBtn.classList.remove('no-show');
        _this.addingNewBook = false;
      }

      App.prototype.toggleNewBookCard = function(_this) {
        if(_this.bookShelf.querySelector('.new-book')) {
          _this.hideNewBookCard(_this);
        } else {
          _this.showNewBookCard(_this);
        }
      }

      App.prototype.newBookButtonEvent = function() {
        let _this = this;
        _this.newBookBtn.addEventListener('click', () => _this.toggleNewBookCard(_this));   
      }      

      App.prototype.removeBookButtonEvent = function() {
        let removeBookButtons = this.bookShelf.querySelectorAll(".book-remove");
        _this = this;
        removeBookButtons.forEach(button => {
          button.addEventListener('click', (e) => {
            removeBookFromLibrary(+e.target.parentElement.getAttribute('data-id'));
            _this.render();
          });
        });
      }  

      App.prototype.handleEditBookButtons = function(_this) {
        // Handle save button
        let saveEditBookBtn = document.querySelector('#btn-editBook-save');
        saveEditBookBtn.addEventListener('click', function(e) {
          e.preventDefault();
          myLibrary[e.target.parentElement.parentElement.parentElement.getAttribute('data-id')].title = document.querySelector("#edit-title").value;
          myLibrary[e.target.parentElement.parentElement.parentElement.getAttribute('data-id')].author = document.querySelector("#edit-author").value;
          myLibrary[e.target.parentElement.parentElement.parentElement.getAttribute('data-id')].pages = document.querySelector("#edit-pages").value;
          myLibrary[e.target.parentElement.parentElement.parentElement.getAttribute('data-id')].read = document.querySelector("#edit-readornot").checked;
          myLibrary[e.target.parentElement.parentElement.parentElement.getAttribute('data-id')].editing = false;
          _this.render();
        });
        
        // Handle cancel button
        let cancelEditBookBtn = document.querySelector('#btn-editBook-cancel');
        cancelEditBookBtn.addEventListener('click', (e) => {
          e.preventDefault();
          myLibrary[e.target.parentElement.parentElement.parentElement.getAttribute('data-id')].editing = false;
          _this.render();
        }); 
      }    

      App.prototype.editButtonEvent = function() {
        let editBookButtons = this.bookShelf.querySelectorAll(".book-edit");
        _this = this;
        editBookButtons.forEach(button => {
          button.addEventListener('click', (e) => {
            let i = 0;
            myLibrary.forEach(book => {
              if(i === +e.target.parentElement.getAttribute('data-id')) {
                myLibrary[i].editing = true;
              } else {
                myLibrary[i].editing = false;
              }
              i++;
            });
            _this.render();
            _this.handleEditBookButtons(_this);
          });
        });
      }

      function parentsContainClass(element, className) {
        if (!element || element.length === 0) {
          return false;
        }
        let parent = element;
        do {
          if (parent === document) {
            break;
          }
          if (parent.classList.contains(className)) {
            return parent;
          }
        } while (parent = parent.parentNode);
        return false;
      }

      let test1 = new Book("The Last Kingdom", "Bernard Cornwell", 415, true);
      let test2 = new Book("How to Win Friends and Influence People", "Dale Carnegie", 268, false);
      let test3 = new Book("Atomic Habits: The life-changing million copy bestseller", "James Clear", 320, false);
      let test4 = new Book("Not a Diet Book: Take Control. Gain Confidence. Change Your Life.", "James Smith", 304, true);
      addBookToLibrary(test1);
      addBookToLibrary(test2);
      addBookToLibrary(test3);
      addBookToLibrary(test4);

      let app = new App();
      app.init();
      app.render();
      app.newBookButtonEvent();
      app.editButtonEvent();

      
    </script>
</html>